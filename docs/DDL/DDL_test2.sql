-- ==========================================
-- DDL_test2.sql
-- 前提: DDL_main1.sql -> DDL_main2.sql 実行済み
-- 目的:
--   1) Reachemployees.csv + 旧Reachemployees.csv を統合した約150件の社員データ投入
--   2) 必要な部署・クライアントを自動追加
--   3) 「馬場雄大（社員ID:2600001）」を管理者ユーザーに関連付け
-- ==========================================

BEGIN;

-- 会社レコード（アプリ既定ID）
INSERT INTO companies (id, company_name)
VALUES ('11111111-1111-1111-1111-111111111111', 'Reach')
ON CONFLICT (id) DO UPDATE SET company_name = EXCLUDED.company_name;

WITH src_raw (
  full_name,
  gender,
  birth_date_text,
  employee_code,
  department_name,
  join_date_text,
  employment_status,
  work_status_text,
  client_name,
  retire_date_text,
  retirement_reason_name,
  note
) AS (
  VALUES('押見洋介','男性','1994/01/01','190000012','','2019/11/26','退職','開発','株式会社ブレーンネット','2022/03/01','ITモチベ低下',''),
('玉田大樹','男性','1994/01/01','190000024','','2019/05/01','退職','開発','株式会社フューチャーアンティークス','2022/05/01','ITモチベ低下',''),
('中村香南子','女性','1994/01/01','190000033','','2019/11/26','退職','開発','日本テムズ株式会社','2022/06/01','同業他社転職',''),
('當間麗那','女性','1994/01/01','190000083','','2019/05/10','退職','開発','日本ナレッジ株式会社','2023/03/01','病気',''),
('椚冬威','男性','1994/01/01','190000121','','2019/08/01','退職','開発','株式会社ボイス','2023/07/01','家庭問題',''),
('渡邊彰子','女性','1994/01/01','190000122','','2019/09/10','退職','開発','フューチャースクエア','2023/07/01','会社不信',''),
('佐々木莉音','女性','1995/01/01','200000001','','2020/11/30','退職','派遣','-','2022/02/01','家庭問題',''),
('川嶌貫太','男性','1995/01/01','200000002','','2020/10/26','退職','派遣','株式会社ヒト・コミュニケーションズ','2022/02/01','ITモチベ低下',''),
('小松正佳','男性','1995/01/01','200000005','','2020/03/27','退職','開発','-','2022/02/01','同業他社転職',''),
('浅野雄司','男性','1995/01/01','200000008','','2020/08/03','退職','開発','ハイミン・エンタープライズ株式会社','2022/03/01','同業他社転職',''),
('遠藤優太','男性','1995/01/01','200000009','','2020/02/14','退職','開発','株式会社S.E.C','2022/03/01','同業他社転職',''),
('小野山雄大','男性','1995/01/01','200000010','','2020/05/12','退職','開発','株式会社ボールド','2022/03/01','同業他社転職',''),
('鈴木優太朗','男性','1995/01/01','200000011','','2020/03/30','退職','開発','株式会社ボールド','2022/03/01','同業他社転職',''),
('小澤将斗','男性','1995/01/01','200000015','','2020/03/27','退職','開発','株式会社ブレーンネット','2022/03/01','家庭問題',''),
('荒舩温','男性','1995/01/01','200000017','','2020/09/21','退職','派遣','株式会社ブレーンネット','2022/03/01','ITモチベ低下',''),
('池上光里','女性','1995/01/01','200000018','','2020/07/09','退職','開発','株式会社ブレーンネット','2022/04/01','会社不信',''),
('北村悠真','男性','1995/01/01','200000021','','2020/01/14','退職','開発','株式会社S.E.C','2022/05/01','同業他社転職',''),
('金森千佳','女性','1995/01/01','200000025','','2020/02/08','退職','開発','アイラビット株式会社','2022/05/01','同業他社転職',''),
('加納直樹','男性','1995/01/01','200000027','','2020/11/05','退職','開発','株式会社ボールド','2022/06/01','同業他社転職',''),
('田中清善','男性','1995/01/01','200000034','','2020/03/27','退職','開発','株式会社グローバル・インフォメーション・テクノロジー','2022/06/01','同業他社転職',''),
('菊地謙吾','男性','1995/01/01','200000035','','2020/11/30','退職','派遣','株式会社ヒト・コミュニケーションズ','2022/06/01','ITモチベ低下',''),
('梅村潤也','男性','1995/01/01','200000037','','2020/12/25','退職','開発','デマンドリンク株式会社','2022/07/01','同業他社転職',''),
('百瀬遼太','男性','1995/01/01','200000038','','2020/05/27','退職','開発','株式会社トラストグロース','2022/07/01','同業他社転職',''),
('椿優香','女性','1995/01/01','200000042','','2020/10/21','退職','開発','株式会社ヒュペリオンテクノロジー','2022/08/01','同業他社転職',''),
('大島京介','男性','1995/01/01','200000043','','2020/11/09','退職','開発','ヒュペリオンテクノロジー','2022/08/01','同業他社転職',''),
('蛭間寛大','男性','1995/01/01','200000044','','2020/08/27','退職','開発','HapInS株式会社','2022/08/01','同業他社転職',''),
('七條遼介','男性','1995/01/01','200000045','','2020/12/24','退職','開発','株式会社 エス・イー・プロジェクト','2022/08/01','同業他社転職',''),
('松瀬慶徳','男性','1995/01/01','200000050','','2020/01/16','退職','開発','株式会社グローバル・インフォメーション・テクノロジー','2022/09/01','同業他社転職',''),
('萩智美','女性','1995/01/01','200000051','','2020/11/02','退職','開発','株式会社グローバル・インフォメーション・テクノロジー','2022/09/01','同業他社転職',''),
('海藤優太','男性','1995/01/01','200000052','','2020/11/02','退職','開発','朝日クリエイト株式会社','2022/09/01','同業他社転職',''),
('繁田航祐','男性','1995/01/01','200000081','','2020/11/13','退職','開発','EBA株式会社','2023/03/01','同業他社転職',''),
('関屋諒','男性','1995/01/01','200000082','','2020/12/01','退職','開発','株式会社アスページ','2023/03/01','ITモチベ低下',''),
('山口拓磨','男性','1995/01/01','200000085','','2020/03/31','退職','開発','株式会社はばたーく','2023/03/01','同業他社転職',''),
('石川奈津希','女性','1995/01/01','200000088','','2020/12/21','退職','開発','株式会社Wytel','2023/04/01','家庭問題',''),
('天野耀介','男性','1995/01/01','200000110','','2020/04/06','退職','開発','日本テムズ株式会社','2023/06/01','同業他社転職',''),
('塩谷淑恭','男性','1995/01/01','200000116','','2020/08/07','退職','開発','株式会社ブレーンネット','2023/06/01','同業他社転職',''),
('内室雄太','男性','1995/01/01','200000119','','2020/10/06','退職','開発','株式会社S.E.C','2023/07/01','同業他社転職',''),
('工藤真菜','女性','1995/01/01','200000120','','2020/12/14','退職','開発','株式会社ブレーンネット','2023/07/01','同業他社転職',''),
('和賀結','女性','1996/01/01','210000003','','2021/01/04','退職','派遣','-','2022/02/01','家庭問題',''),
('福地和樹','男性','1996/01/01','210000004','','2021/02/01','退職','開発','株式会社cuatro pistas','2022/02/01','同業他社転職',''),
('愛甲知央','男性','1996/01/01','210000006','','2021/02/05','退職','開発','株式会社アイグルーヴ','2022/02/01','同業他社転職',''),
('松木舞','女性','1996/01/01','210000013','','2021/11/01','退職','開発','株式会社エイティーエックス','2022/03/01','同業他社転職',''),
('小山尚朗','男性','1996/01/01','210000014','','2021/01/25','退職','派遣','株式会社ヒト・コミュニケーションズ','2022/03/01','ITモチベ低下',''),
('根本拓真','男性','1996/01/01','210000016','','2021/10/01','退職','派遣','株式会社ブレーンネット','2022/03/01','ITモチベ低下',''),
('藤田愛璃彩','女性','1996/01/01','210000019','','2021/02/05','退職','開発','株式会社ブレイバンステクノロジーズ','2022/04/01','同業他社転職',''),
('古川達也','男性','1996/01/01','210000020','','2021/01/25','退職','派遣','株式会社ヒト・コミュニケーションズ','2022/05/01','会社不信',''),
('吉田剛','男性','1996/01/01','210000026','','2021/11/08','退職','派遣','株式会社コンフィデンス','2022/05/01','ITモチベ低下',''),
('伊藤恭介','男性','1996/01/01','210000032','','2021/01/11','退職','開発','株式会社ヒュペリオンテクノロジー','2022/06/01','ITモチベ低下',''),
('大塲駿','男性','1996/01/01','210000046','','2021/09/09','退職','陸特','株式会社Crane＆I','2022/09/01','ITモチベ低下',''),
('松岡実','男性','1996/01/01','210000053','','2021/10/13','退職','陸特','株式会社ブレーンネット','2022/09/01','金銭問題',''),
('菅原誠志郎','男性','1996/01/01','210000054','','2021/02/09','退職','派遣','株式会社インバウンドテック','2022/09/01','会社不信',''),
('砥石久瑠実','女性','1996/01/01','210000062','','2021/01/11','退職','開発','VIPソフトウェア株式会社','2022/11/01','同業他社転職',''),
('黒田渉太郎','男性','1996/01/01','210000063','','2021/02/01','退職','開発','株式会社ファイン・ネット','2022/11/01','同業他社転職',''),
('佐々木祐介','男性','1996/01/01','210000078','','2021/11/01','退職','陸特','株式会社フュージョニア','2023/03/01','同業他社転職',''),
('田岡真輝','男性','1996/01/01','210000079','','2021/04/01','退職','開発','soam.ICT株式会社','2023/03/01','ITモチベ低下',''),
('中村信也','男性','1996/01/01','210000087','','2021/10/20','退職','派遣','株式会社アップデートホールディングス','2023/03/01','病気',''),
('川上美佐穂','女性','1996/01/01','210000111','','2021/02/12','退職','開発','株式会社エイプリルナイツ','2023/06/01','ITモチベ低下',''),
('柳綾子','女性','1996/01/01','210000113','','2021/02/22','退職','開発','ティアンドエス株式会社','2023/06/01','同業他社転職',''),
('赤崎秀一','男性','1996/01/01','210000114','','2021/03/05','退職','開発','株式会社EBA','2023/06/01','同業他社転職',''),
('柳綾子','女性','1996/01/01','210000118','','2021/02/22','退職','開発','ティアンドエス株式会社','2023/07/01','会社不信',''),
('森祐哉','男性','1997/01/01','220000007','','2022/01/10','退職','派遣','株式会社マニフェスト','2022/02/01','稼働問題',''),
('河野智樹','男性','1997/01/01','220000022','','2022/01/05','退職','陸特','株式会社Pro-SPIRE','2022/05/01','家庭問題',''),
('鈴木文音','女性','1997/01/01','220000023','','2022/04/06','退職','派遣','株式会社マニフェスト','2022/05/01','稼働問題',''),
('千徳陽矢','男性','1997/01/01','220000028','','2022/06/06','退職','派遣','株式会社ヒトコミュニケーションズ','2022/07/01','会社不信',''),
('村田卓弥','男性','1997/01/01','220000029','','2022/06/08','退職','派遣','BIGUP株式会社','2022/07/01','家庭問題',''),
('丸山克輝','男性','1997/01/01','220000030','','2022/02/01','退職','陸特','株式会社ユキシステムデザイン','2022/06/01','金銭問題',''),
('村上花怜','女性','1997/01/01','220000031','','2022/02/01','退職','陸特','株式会社イーフォルム','2022/06/01','金銭問題',''),
('岡重洸希','男性','1997/01/01','220000036','','2022/02/04','退職','陸特','株式会社ブレーンネット','2022/07/01','家庭問題',''),
('大塚雅弘','男性','1997/01/01','220000039','','2022/05/11','退職','派遣','株式会社マニフェスト','2022/07/01','稼働問題',''),
('大矢美里','女性','1997/01/01','220000040','','2022/04/01','退職','陸特','株式会社ヒト・コミュニケーションズ','2022/07/01','会社不信',''),
('秋定迅','男性','1997/01/01','220000041','','2022/07/11','退職','派遣','株式会社コンフィデンス','2022/08/01','稼働問題',''),
('水品陽色','男性','1997/01/01','220000047','','2022/06/30','退職','派遣','株式会社ヒトコミュニケーションズ','2022/09/01','家庭問題',''),
('福留廉治','男性','1997/01/01','220000048','','2022/06/30','退職','派遣','BIGUP株式会社','2022/09/01','金銭問題',''),
('依田弘輝','男性','1997/01/01','220000049','','2022/04/01','退職','派遣','DOOL株式会社','2022/09/01','会社不信',''),
('高橋知暉','男性','1997/01/01','220000055','','2022/08/16','退職','派遣','株式会社shelter','2022/09/01','稼働問題',''),
('安田裕翔','男性','1997/01/01','220000056','','2022/04/26','退職','陸特','株式会社ブール・ジャパン','2022/10/01','会社不信',''),
('山口優愛','女性','1997/01/01','220000057','','2022/05/16','退職','派遣','株式会社アイビーエス','2022/10/01','会社不信',''),
('市川航大','男性','1997/01/01','220000058','','2022/01/10','退職','派遣','株式会社shelter','2022/10/01','稼働問題',''),
('岩田佳恵','女性','1997/01/01','220000059','','2022/10/06','退職','派遣','株式会社アデコ','2022/11/01','稼働問題',''),
('佐々木大和','男性','1997/01/01','220000060','','2022/04/09','退職','派遣','株式会社AXIS','2022/11/01','稼働問題',''),
('木村太陽','男性','1997/01/01','220000061','','2022/04/01','退職','陸特','株式会社ベストサポートシステムズ','2022/11/01','同業他社転職',''),
('新垣 惇','男性','1997/01/01','220000064','','2022/10/13','退職','派遣','株式会社アデコ','2022/11/01','家庭問題',''),
('岡本健司','男性','1997/01/01','220000065','','2022/02/10','退職','陸特','株式会社ワールドフェイマス','2022/12/01','同業他社転職',''),
('佐藤京太郎','男性','1997/01/01','220000066','','2022/03/01','退職','陸特','株式会社ベストサポートシステムズ','2022/12/01','ITモチベ低下',''),
('宍戸成実','女性','1997/01/01','220000067','','2022/11/08','退職','派遣','株式会社アデコ','2022/12/01','家庭問題',''),
('村松大樹','男性','1997/01/01','220000068','','2022/02/01','退職','開発','スカイリーフ株式会社','2022/12/01','同業他社転職',''),
('赤石勇希','男性','1997/01/01','220000069','','2022/07/26','退職','陸特','株式会社アデコ','2022/12/01','会社不信',''),
('本多亘輝','男性','1997/01/01','220000070','','2022/02/10','退職','陸特','株式会社ワールドフェイマス','2023/01/01','同業他社転職',''),
('大井直生','男性','1997/01/01','220000071','','2022/03/31','退職','陸特','株式会社ユキシステムデザイン','2023/01/01','同業他社転職',''),
('福村愛実','女性','1997/01/01','220000074','','2022/11/08','退職','派遣','株式会社アデコ','2023/02/01','家庭問題',''),
('中林真衣','女性','1997/01/01','220000075','','2022/04/03','退職','陸特','株式会社フューチャーコネクション','2023/03/01','ITモチベ低下',''),
('小野恭平','男性','1997/01/01','220000076','','2022/09/26','退職','派遣','株式会社AXIS','2023/02/01','同業他社転職',''),
('小板橋功一','男性','1997/01/01','220000077','','2022/11/25','退職','派遣','株式会社ユニット','2023/03/01','金銭問題',''),
('大関瑛裕','男性','1997/01/01','220000080','','2022/06/13','退職','陸特','株式会社ブール・ジャパン','2023/03/01','ITモチベ低下',''),
('小林大起','男性','1997/01/01','220000084','','2022/04/01','退職','陸特','株式会社ブレーンネット','2023/03/01','同業他社転職',''),
('岡崎さくら','女性','1997/01/01','220000086','','2022/01/10','退職','陸特','株式会社D&D','2023/03/01','稼働問題',''),
('津川忠久','男性','1997/01/01','220000089','','2022/11/25','退職','派遣','株式会社アデコ','2023/04/01','ITモチベ低下',''),
('松本豊','男性','1997/01/01','220000090','','2022/04/11','退職','陸特','株式会社ユキシステムデザイン','2023/04/01','金銭問題',''),
('木下祐一','男性','1997/01/01','220000092','','2022/12/23','退職','派遣','株式会社アデコ','2023/04/01','ITモチベ低下',''),
('鈴木崇士','男性','1997/01/01','220000097','','2022/04/03','退職','陸特','株式会社ユキシステムデザイン','2023/05/01','ITモチベ低下',''),
('松井健登','男性','1997/01/01','220000099','','2022/06/10','退職','派遣','株式会社shelter','2023/05/01','ITモチベ低下',''),
('玉置愛理','女性','1997/01/01','220000104','','2022/01/05','退職','陸特','株式会社八興システムズ','2023/06/01','同業他社転職',''),
('鶴見光宏','男性','1997/01/01','220000105','','2022/09/23','退職','陸特','株式会社ブレイバンステクノロジーズ','2023/06/01','病気',''),
('夏目拓弥','男性','1997/01/01','220000108','','2022/10/13','退職','開発','ティアンドエス株式会社','2023/06/01','会社不信',''),
('坂口璃紗','女性','1997/01/01','220000109','','2022/05/02','退職','派遣','株式会社マニフェスト','2023/06/01','稼働問題',''),
('秋元崇歩','男性','1997/01/01','220000112','','2022/05/06','退職','開発','朝日クリエイト株式会社','2023/06/01','同業他社転職',''),
('菖蒲川拓椰','男性','1998/01/01','230000072','','2023/01/20','退職','派遣','株式会社マニフェスト','2023/02/01','稼働問題',''),
('上田優香','女性','1998/01/01','230000073','','2023/02/20','退職','派遣','株式会社アデコ','2023/03/01','ITモチベ低下',''),
('西川怜央','男性','1998/01/01','230000091','','2023/02/06','退職','派遣','Goistech株式会社','2023/04/01','同業他社転職',''),
('金田治樹','男性','1998/01/01','230000093','','2023/03/01','退職','派遣','株式会社コンフィデンス','2023/04/01','病気',''),
('菅野早希','女性','1998/01/01','230000094','','2023/03/07','退職','派遣','株式会社アデコ','2023/05/01','家庭問題',''),
('室祐一郎','男性','1998/01/01','230000095','','2023/01/23','退職','陸特','株式会社ネットサポート','2023/05/01','家庭問題',''),
('石川晃大','男性','1998/01/01','230000096','','2023/04/12','退職','派遣','株式会社インバウンドテック','2023/05/01','ITモチベ低下',''),
('眞子航碩','男性','1998/01/01','230000098','','2023/04/06','退職','派遣','BIGUP株式会社','2023/05/01','金銭問題',''),
('小川貴美','女性','1998/01/01','230000100','','2023/04/01','退職','内勤','Y&IGROUP株式会社人事部','2023/05/01','家庭問題',''),
('大木翔太郎','男性','1998/01/01','230000101','','2023/04/11','退職','派遣','アデコ株式会社','2023/05/01','金銭問題',''),
('川島早絢','女性','1998/01/01','230000102','','2023/04/11','退職','派遣','アデコ株式会社','2023/05/01','ITモチベ低下',''),
('稲穂一希','男性','1998/01/01','230000103','','2023/04/01','退職','派遣','アデコ株式会社','2023/06/01','同業他社転職',''),
('古田敦','男性','1998/01/01','230000106','','2023/05/08','退職','派遣','BIGUP株式会社','2023/06/01','金銭問題',''),
('芝真依','女性','1998/01/01','230000107','','2023/03/01','退職','派遣','株式会社ピーエスシー','2023/06/01','ITモチベ低下',''),
('三東綾香','女性','1998/01/01','230000115','','2023/05/08','退職','派遣','ヒトコム','2023/06/01','ITモチベ低下',''),
('村松脩平','男性','1998/01/01','230000117','','2023/04/01','退職','派遣','アデコ株式会社','2023/07/01','ITモチベ低下',''),
('馬場雄大','男性','1998/04/18','2600001','','2023/10/01','在籍','稼働','BEYO','','',''),
('森雄樹','男性','1998/08/14','2600002','','2023/11/01','退職','稼働','BEYO','2023/11/10','ITモチベ低下',''),
('塚越蓮','男性','1996/04/03','2600003','','2023/11/01','在籍','稼働','miraie','','',''),
('西山紘平','男性','1996/03/14','2600004','','2023/11/01','在籍','稼働','MAIS','','',''),
('石橋亮典','男性','1997/05/09','2600005','','2023/12/01','在籍','稼働','レソナ','','',''),
('野口歩','男性','2002/04/04','2600006','','2023/12/05','退職','稼働','BEYO','2023/12/08','ITモチベ低下',''),
('伊東太輔','男性','1993/03/03','2600007','','2024/01/03','退職','稼働','miraie','2025/12/31','キャリア',''),
('矢川雄也','男性','1999/04/20','2600008','','2023/12/22','退職','稼働','BEYO','2024/02/21','ITモチベ低下',''),
('千葉愛加','女性','2000/05/10','2600009','','2024/01/04','退職','稼働','ソルク','2024/01/04','ITモチベ低下',''),
('大川礼','男性','1999/05/11','2600010','','2024/02/01','退職','稼働','intense','2025/05/01','ITモチベ低下',''),
('櫻沢志子','女性','1999/06/18','2600011','','2024/02/09','退職','稼働','リヴェル','2024/03/31','ITモチベ低下',''),
('新井田姫','女性','1997/07/03','2600012','','2024/04/01','退職','稼働','リヴェル','2024/04/10','ITモチベ低下',''),
('盛永真','男性','2001/10/29','2600013','','2024/04/01','退職','稼働','Reach','2025/05/01','家庭問題',''),
('岡田真次','男性','1998/01/28','2600014','','2024/03/25','在籍','稼働','百郷','','',''),
('井手彩奈','女性','2001/05/14','2600015','','2024/04/01','退職','稼働','miraie','2025/12/01','同業他社転職',''),
('三部涼太','男性','2003/07/13','2600016','','2024/04/15','在籍','稼働','engine','','',''),
('島崎悠太','男性','1995/09/28','2600017','','2024/04/12','退職','稼働','MAIS','2024/07/23','ITモチベ低下',''),
('伊藤真理子','女性','1999/04/07','2600018','','2024/06/26','退職','稼働','MindS','2025/08/29','ITモチベ低下',''),
('朝井萌子','女性','1995/01/18','2600019','','2024/09/01','退職','稼働','ソルク','2024/09/01','ITモチベ低下',''),
('紙石美空','女性','2002/10/08','2600020','','2024/09/01','退職','稼働','リヴェル','2024/10/22','家庭問題',''),
('宮野瑞奈','女性','2003/05/28','2600021','','2024/11/01','退職','稼働','miraie','2025/10/12','家庭問題',''),
('村田晶','男性','1998/12/28','2600022','','2024/10/11','在籍','稼働','miraie','','',''),
('梅村美里','女性','2005/03/29','2600023','','2024/12/01','退職','稼働','intense','2025/02/28','会社不信',''),
('保泉アリ','女性','2001/04/18','2600024','','2025/02/01','在籍','稼働','miraie','','',''),
('西尾美七','女性','1999/02/10','2600025','','2025/04/01','退職','稼働','intense','2025/04/10','会社不信',''),
('中島裕人','男性','1999/11/09','2600026','','2025/01/01','在籍','稼働','miraie','','',''),
('大貫海','男性','2004/06/24','2600027','','2025/05/08','退職','稼働','BEYO','2025/07/30','ITモチベ低下',''),
('中村海晟','男性','2004/06/12','2600028','','2025/05/19','退職','稼働','intense','2025/08/31','ITモチベ低下',''),
('西本成那','女性','1997/10/28','2600029','','2025/10/08','退職','稼働','MindS','2025/11/30','会社不信',''),
('伊藤裕亮','男性','1993/10/08','2600030','','2026/01/01','在籍','稼働','MAIS','','',''),
('竹花翔','男性','1997/09/18','2600031','','2025/12/18','在籍','稼働','','','','')),
normalized AS (
  SELECT
    NULLIF(TRIM(full_name), '') AS full_name,
    NULLIF(TRIM(gender), '') AS gender,
    NULLIF(TRIM(birth_date_text), '') AS birth_date_text,
    NULLIF(TRIM(employee_code), '') AS employee_code,
    COALESCE(NULLIF(TRIM(department_name), ''), '未所属') AS department_name,
    NULLIF(TRIM(join_date_text), '') AS join_date_text,
    NULLIF(TRIM(employment_status), '') AS employment_status,
    NULLIF(TRIM(work_status_text), '') AS work_status_text,
    NULLIF(NULLIF(TRIM(client_name), ''), '-') AS client_name,
    NULLIF(TRIM(retire_date_text), '') AS retire_date_text,
    NULLIF(TRIM(retirement_reason_name), '') AS retirement_reason_name,
    NULLIF(TRIM(note), '') AS note
  FROM src_raw
  WHERE NULLIF(TRIM(employee_code), '') IS NOT NULL
),
prepared AS (
  SELECT
    full_name,
    gender,
    CASE WHEN birth_date_text IS NULL THEN NULL ELSE TO_DATE(birth_date_text, 'YYYY/MM/DD') END AS birth_date,
    employee_code,
    department_name,
    CASE WHEN join_date_text IS NULL THEN NULL ELSE TO_DATE(join_date_text, 'YYYY/MM/DD') END AS join_date,
    employment_status,
    CASE
      WHEN work_status_text IN ('休職', '休職中') THEN '休職'
      WHEN work_status_text IN ('待機', '待機中') THEN '待機'
      WHEN work_status_text IN ('稼働', '稼働中', '派遣', '開発', '陸特') THEN '稼働'
      ELSE '稼働'
    END AS work_status_name,
    client_name,
    CASE WHEN retire_date_text IS NULL THEN NULL ELSE TO_DATE(retire_date_text, 'YYYY/MM/DD') END AS retire_date,
    CASE
      WHEN retirement_reason_name = 'キャリア' THEN 'キャリアアップ'
      WHEN retirement_reason_name = '稼働問題' THEN 'ITモチベ低下'
      ELSE retirement_reason_name
    END AS retirement_reason_name,
    note
  FROM normalized
),
ensure_departments AS (
  INSERT INTO departments (company_id, code, name)
  SELECT
    '11111111-1111-1111-1111-111111111111',
    NULL,
    src.department_name
  FROM (SELECT DISTINCT department_name FROM prepared WHERE department_name IS NOT NULL) src
  WHERE NOT EXISTS (
    SELECT 1
    FROM departments d
    WHERE d.company_id = '11111111-1111-1111-1111-111111111111'
      AND d.name = src.department_name
  )
  RETURNING id
),
ensure_clients AS (
  INSERT INTO clients (company_id, name)
  SELECT
    '11111111-1111-1111-1111-111111111111',
    src.client_name
  FROM (SELECT DISTINCT client_name FROM prepared WHERE client_name IS NOT NULL) src
  WHERE NOT EXISTS (
    SELECT 1
    FROM clients c
    WHERE c.company_id = '11111111-1111-1111-1111-111111111111'
      AND c.name = src.client_name
  )
  RETURNING id
),
delete_existing_employees AS (
  DELETE FROM employees e
  USING prepared p
  WHERE e.employee_code = p.employee_code
  RETURNING e.id
),
inserted_employees AS (
  INSERT INTO employees (
    employee_code,
    full_name,
    gender,
    birth_date,
    join_date,
    retire_date,
    retirement_reason_id,
    retirement_reason_text,
    department_id,
    work_status_id,
    client_id
  )
  SELECT
    p.employee_code,
    p.full_name,
    p.gender,
    p.birth_date,
    p.join_date,
    p.retire_date,
    rr.id,
    CASE
      WHEN rr.id IS NULL THEN p.retirement_reason_name
      ELSE NULL
    END AS retirement_reason_text,
    d.id AS department_id,
    ws.id AS work_status_id,
    c.id AS client_id
  FROM prepared p
  JOIN departments d
    ON d.company_id = '11111111-1111-1111-1111-111111111111'
   AND d.name = p.department_name
  JOIN work_statuses ws
    ON ws.name = p.work_status_name
  LEFT JOIN clients c
    ON c.company_id = '11111111-1111-1111-1111-111111111111'
   AND c.name = p.client_name
  LEFT JOIN retirement_reasons rr
    ON rr.name = p.retirement_reason_name
  RETURNING id, employee_code, full_name
),
delete_admin_user AS (
  DELETE FROM users
  WHERE company_id = '11111111-1111-1111-1111-111111111111'
    AND email = 'test1@example.com'
  RETURNING id
)
INSERT INTO users (company_id, employee_id, email, password, role)
SELECT
  '11111111-1111-1111-1111-111111111111',
  e.id,
  'test1@example.com',
  'testpassword1',
  'admin'
FROM employees e
WHERE e.employee_code = '2600001'
LIMIT 1;

COMMIT;

-- 確認用クエリ
-- SELECT COUNT(*) AS employee_count FROM employees;
-- SELECT full_name, employee_code FROM employees WHERE employee_code = '2600001';
-- SELECT email, role, employee_id FROM users WHERE email = 'test1@example.com';
